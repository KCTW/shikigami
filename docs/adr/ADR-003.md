# ADR-003：SQA 稽核閘門介入模式

**狀態**：Accepted
**日期**：2026-03-01
**決策者**：Architect
**挑戰者**：QA Engineer

---

## 背景

框架 QA 審計發現 16 項監控缺口（3 CRITICAL / 6 HIGH / 6 MEDIUM / 1 LOW），根因之一是框架文件修改、Sprint 外變更、儀式完整性等流程環節缺乏結構性監督機制。現有 QA Engineer 僅負責產品品質（Spec Compliance + Code Quality），流程品質無人把關。

設計張力存在於兩個既有原則之間：

1. **scrum-master SKILL.md 第 6.1 節「不阻塞原則」**：流程中避免停下來等待，決策點依專案等級自動處理。
2. **quality-gate SKILL.md 的 Hard Gate 模式**：有效的閘門必須具備強制性，無法通過時不得繼續。

若全部採用非同步警告，則與「只是寫下規則」無異。若全部阻塞，則大量稽核事件造成流程停頓。

## 決策問題

流程品質稽核的四個場景應採用什麼介入模式（同步阻塞 Hard Gate vs 非同步警告 Soft Gate）？

| 場景 | 觸發條件 |
|------|----------|
| Framework Document Change Audit | `skills/`、`commands/`、`agents/` 下 `.md` 被修改 |
| Out-of-Sprint Change Audit | Sprint 期間發生非 Sprint Backlog 範圍的框架文件修改 |
| Story Completion DoD Audit | Story 完成後、quality-gate 通過後 |
| Ceremony Integrity Audit | Sprint Planning 或 Sprint Review 儀式結束前 |

## 選項分析

### 選項 A：全部同步阻塞（Hard Gate）

四個場景全部採用 Hard Gate，稽核不通過則流程停止。

- 優點：稽核有最強執行力，規則不可繞過；與現有 quality-gate Hard Gate 模式一致
- 缺點：Story Completion DoD Audit 頻率極高（每個 Story），造成日常開發節奏嚴重干擾；與第 6.1 節「不阻塞原則」直接衝突
- 風險：Out-of-Sprint Change Audit 阻塞行為在緊急修正場景造成僵局

### 選項 B：全部非同步警告（Soft Gate）

四個場景全部採用 Soft Gate，稽核結果記錄為警告，Sprint Review 時集中回顧。

- 優點：完全符合不阻塞原則，流程暢通
- 缺點：「警告」與「規則」在效果上幾乎等同，SQA 存在價值被稀釋；框架文件品質問題可能數週後才被注意
- 風險：技術債累積——多個警告被忽略時，框架文件品質螺旋下降

### 選項 C：分級介入（採用）

依稽核場景的影響範圍與發生頻率，差異化分配。

| 場景 | 介入模式 | 理由 |
|------|----------|------|
| Framework Document Change Audit | **Hard Gate** | 框架文件是全團隊共享的契約，修改後若品質不符影響所有後續 Sprint；發生頻率低，阻塞代價可接受 |
| Out-of-Sprint Change Audit | **Hard Gate** | Sprint 外的框架修改違反 Sprint 節奏保護原則；若允許繞過，Sprint 邊界形同虛設；緊急情況有明確例外路徑 |
| Story Completion DoD Audit | **Soft Gate** | 每個 Story 完成都觸發，頻率高；quality-gate 已有 Hard Gate 保護代碼品質；此處補充「流程合規性觀察」不重複已有阻塞機制 |
| Ceremony Integrity Audit | **Hard Gate** | 儀式完整性是 Scrum 框架的基礎；頻率低（每 Sprint 兩次），阻塞代價可接受 |

- 優點：Hard Gate 集中於低頻高影響場景，不干擾日常節奏；Soft Gate 用於高頻日常場景，符合不阻塞原則
- 缺點：兩種模式並存，認知複雜度略高

## 決策

**採用選項 C（分級介入）。**

核心判準為兩個維度的交叉：

1. **影響範圍**：Framework Document Change 和 Ceremony Integrity 的缺陷是系統性的，一旦滑過就影響整個框架；Story DoD 的缺陷是局部的，quality-gate 已有機制攔截。
2. **發生頻率**：Hard Gate 的正當性需要低頻率支撐，否則阻塞本身成為效率瓶頸。每 Sprint 只有少數框架文件修改事件和兩次 Ceremony，Hard Gate 不造成停頓；每個 Story 完成都掛 Hard Gate 則每天都在等待。

不阻塞原則相容性：Soft Gate 場景完全符合第 6.1 節。Hard Gate 場景頻率低，且在第 6.1 節既有框架內（「有明確的流程規則可依循時，按規則自動執行」）。

## 實作方式

### Hard Gate：Framework Document Change Audit

```
觸發條件：skills/、commands/、agents/ 下任一 .md 檔案修改
介入時機：修改操作前

Checklist（二元判定）：
  [ ] 修改目的對應 Sprint Backlog 中的某個 Story ID
  [ ] 修改範圍在該 Story 的 AC 所涵蓋文件範圍內
  [ ] 修改前已讀取目標文件的當前版本
  [ ] 修改後執行 health-check 確認結構完整性

結果：全部 Pass → 繼續；任一 Fail → 阻塞，修復後重新稽核
```

### Hard Gate：Out-of-Sprint Change Audit

```
觸發條件：Sprint 期間偵測到 Sprint Backlog 無對應項目的框架文件修改

正常路徑：
  修改必須對應 Backlog Story → 若無，必須先由 PO 建立緊急 Story → 核准後方可修改

緊急例外路徑（僅限安全漏洞或框架破損）：
  1. 記錄緊急變更原因（commit message 標注 [EMERGENCY]）
  2. 事後稽核（48 小時內）
  3. Sprint Review 時列入 Retrospective Problem 追蹤
```

### Hard Gate：Ceremony Integrity Audit

```
觸發條件：Sprint Planning 或 Sprint Review 宣告結束前

Sprint Planning 必要條件：
  [ ] Sprint Goal 已定義
  [ ] Sprint Backlog 已選取並完成 Story 點數估算
  [ ] 所有 Story 有明確 Acceptance Criteria
  [ ] GitHub open issues 已掃描

Sprint Review 必要條件：
  [ ] PO Demo 已完成
  [ ] Stakeholder 已確認
  [ ] Retrospective_Log.md 已更新
  [ ] Action Items 已建立
  [ ] ROADMAP.md 已更新

結果：全部勾選 → 儀式可結束；任一未完成 → 阻塞，補齊後方可結束
```

### Soft Gate：Story Completion DoD Audit

```
觸發條件：quality-gate 通過後，Story 標記完成前
介入模式：非同步，不阻塞 Story 標記完成

觀察項目：
  - Story 是否走過完整 sprint-execution → quality-gate 流程
  - 相關設計文件是否已更新
  - Metrics_Log.md 是否已記錄

輸出：
  合規 → 靜默通過
  觀察到偏差 → 記錄至 Sprint Review Retrospective Problem
```

## Decision Challenge（QA Engineer）

**挑戰**：選項 B 的最強論述——不阻塞原則是 Shikigami 自治策略的核心設計決策。選項 C 的 Hard Gate 場景在緊急情況下仍會阻塞，而緊急情況恰恰是最需要快速行動的時候。更好的設計是全部 Soft Gate，但在 Sprint Review 時對累積的觀察實施強制回應機制。

**反駁**：Soft Gate 的「Sprint Review 集中回顧」有根本缺陷——時間距離破壞修正成本。Framework Document Change 若品質不符，在 2-4 週後才被發現，期間所有依賴此文件的 Sprint 執行都在錯誤基礎上運行，修正代價是指數級的。緊急情況已透過例外路徑（`[EMERGENCY]` 標注 + 事後稽核）解決，Hard Gate 的正常路徑保護的是「非緊急的日常修改」——完全不需要繞過稽核。
