# ADR-002：測試框架技術選型

**狀態**：Accepted
**日期**：2026-02-28
**決策者**：Architect
**挑戰者**：QA Engineer

---

## 背景

Shikigami 是 Markdown 指令框架，目前唯一驗證方式是在真實專案上安裝並手動測試。需要自動化驗證機制，確保結構完整性、交叉引用正確性、Schema 合規性。

核心需求：解析 YAML frontmatter + 驗證 JSON Schema + 可在 CI 執行。

---

## 選項

### Option A：Bash（grep + jq）

| 優點 | 缺點 |
|------|------|
| 零依賴 | YAML frontmatter 解析困難且脆弱 |
| CI 友好 | 字串處理容易出錯 |
| 所有環境都有 | 可讀性差，維護成本高 |

### Option B：Python（PyYAML + jsonschema）

| 優點 | 缺點 |
|------|------|
| YAML/JSON 解析原生支援 | 需要 Python runtime |
| 可讀性好，維護成本低 | CI 需 `pip install pyyaml jsonschema` |
| 本機已安裝 PyYAML + jsonschema | 框架本身不是 Python 專案 |

### Option C：Node.js（js-yaml）

| 優點 | 缺點 |
|------|------|
| Claude Code 生態自然搭配 | 本機未安裝 js-yaml |
| JSON 處理原生 | 需引入 package.json（語意不合） |

---

## 決策

**採用 Option B：Python**

理由：
1. 本機環境已有 Python 3.12 + PyYAML + jsonschema，零額外安裝
2. YAML frontmatter 解析是核心需求，Bash 無法可靠完成
3. Node.js 缺少 js-yaml，需引入 npm 生態，與 Markdown 框架語意不符
4. Python 腳本可讀性好，未來維護成本低

取捨：
- CI 需要 `pip install pyyaml jsonschema`（可接受，一行解決）
- 本機使用者需要 Python 3（GitHub Actions 已預裝，大部分開發環境也有）
- 不建立 `requirements.txt`，避免讓 Markdown 框架看起來像 Python 專案

---

## Decision Challenge（QA 挑戰）

**QA**：為什麼不用 Bash？框架是 Markdown，引入 Python 是否過度工程？

**Architect 回應**：
- Bash 解析 YAML frontmatter 需要 `sed` + `awk` + 多層 regex，實測脆弱且難維護
- Python 的 `yaml.safe_load()` 一行解決，且能正確處理多行 description、特殊字元
- 測試腳本本身也需要被維護，可讀性是關鍵考量
- 不建立 `requirements.txt`，最小化 Python 足跡

**QA 結論**：同意。Python 的引入是有節制的（僅 tests/ 目錄），不污染框架主體。

---

## 影響

- 新增 `tests/` 目錄，放置 Python 測試腳本
- 新增 `.github/workflows/validate.yml`，CI 自動執行
- 不引入 `requirements.txt`、`setup.py` 等 Python 專案結構
- README 新增「開發者：執行測試」段落
